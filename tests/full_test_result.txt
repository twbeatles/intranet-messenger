============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- C:\Python314\python.exe
cachedir: .pytest_cache
rootdir: G:\다른 컴퓨터\내 컴퓨터\google antigravity\intranet-messenger-main
plugins: anyio-4.12.0, flask-1.3.0
collecting ... collected 24 items

tests/test_admin_kick_protection.py::test_kick_admin_by_admin PASSED     [  4%]
tests/test_admin_kick_protection.py::test_kick_regular_member_by_admin PASSED [  8%]
tests/test_admin_protection.py::test_cannot_remove_last_admin PASSED     [ 12%]
tests/test_admin_protection.py::test_creator_is_auto_admin PASSED        [ 16%]
tests/test_admin_protection.py::test_only_admin_can_delete_pin FAILED    [ 20%]
tests/test_admin_protection.py::test_admin_can_remove_another_admin_if_not_last PASSED [ 25%]
tests/test_authorization.py::test_invite_nonexistent_user PASSED         [ 29%]
tests/test_authorization.py::test_invite_existing_user PASSED            [ 33%]
tests/test_authorization.py::test_session_regeneration_on_login PASSED   [ 37%]
tests/test_basic.py::test_home_page PASSED                               [ 41%]
tests/test_basic.py::test_register_login PASSED                          [ 45%]
tests/test_basic.py::test_login_fail PASSED                              [ 50%]
tests/test_kick_member.py::test_kick_member_success PASSED               [ 54%]
tests/test_kick_member.py::test_kick_member_not_admin PASSED             [ 58%]
tests/test_kick_member.py::test_kick_self PASSED                         [ 62%]
tests/test_kick_member.py::test_kick_nonmember PASSED                    [ 66%]
tests/test_maintenance.py::test_close_expired_polls PASSED               [ 70%]
tests/test_maintenance.py::test_cleanup_old_access_logs PASSED           [ 75%]
tests/test_polls.py::test_create_poll PASSED                             [ 79%]
tests/test_polls.py::test_vote_poll PASSED                               [ 83%]
tests/test_polls.py::test_close_poll PASSED                              [ 87%]
tests/test_user_deletion.py::test_user_deletion_cleanup PASSED           [ 91%]
tests/test_user_deletion.py::test_user_deletion_wrong_password PASSED    [ 95%]
tests/test_user_deletion.py::test_change_password PASSED                 [100%]

================================== FAILURES ===================================
_______________________ test_only_admin_can_delete_pin ________________________

client = <FlaskClient <Flask 'app'>>

    def test_only_admin_can_delete_pin(client):
        """일반 멤버가 공지 삭제 시 403 에러 확인"""
        # 두 사용자 등록
        client.post('/api/register', json={
            'username': 'pin_admin',
            'password': 'password123',
            'nickname': 'Pin Admin'
        })
        client.post('/api/register', json={
            'username': 'pin_member',
            'password': 'password123',
            'nickname': 'Pin Member'
        })
    
        # 관리자로 로그인 후 방 생성
        client.post('/api/login', json={
            'username': 'pin_admin',
            'password': 'password123'
        })
    
        response = client.post('/api/rooms', json={
            'name': 'Pin Delete Test Room',
            'members': [1, 2]
        })
        room_id = response.json['room_id']
    
        # 공지 생성
        response = client.post(f'/api/rooms/{room_id}/pins', json={
            'content': '테스트 공지'
        })
        assert response.status_code == 200
        pin_id = response.json['pin_id']
    
        # 일반 멤버로 로그인
        client.post('/api/logout')
        client.post('/api/login', json={
            'username': 'pin_member',
            'password': 'password123'
        })
    
        # 공지 삭제 시도 - 실패해야 함
        response = client.delete(f'/api/rooms/{room_id}/pins/{pin_id}')
>       assert response.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests\test_admin_protection.py:109: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  app.models:models.py:1312 Unauthorized unpin attempt: user=2, pin=1
============================== warnings summary ===============================
tests/test_admin_kick_protection.py::test_kick_admin_by_admin
  G:\다른 컴퓨터\내 컴퓨터\google antigravity\intranet-messenger-main\app\__init__.py:21: MonkeyPatchWarning: Monkey-patching ssl after ssl has already been imported may lead to errors, including RecursionError on Python 3.6. It may also silently lead to incorrect behaviour on Python 3.7. Please monkey-patch earlier. See https://github.com/gevent/gevent/issues/1016. Modules that had direct imports (NOT patched): ['anyio.streams.tls (C:\\Python314\\Lib\\site-packages\\anyio\\streams\\tls.py)']. 
    monkey.patch_all()

tests/test_admin_kick_protection.py: 2 warnings
tests/test_admin_protection.py: 4 warnings
tests/test_authorization.py: 3 warnings
tests/test_basic.py: 3 warnings
tests/test_kick_member.py: 4 warnings
tests/test_maintenance.py: 2 warnings
tests/test_polls.py: 3 warnings
tests/test_user_deletion.py: 3 warnings
  C:\Python314\Lib\site-packages\flask_session\filesystem\filesystem.py:75: DeprecationWarning: FileSystemSessionInterface is deprecated and will be removed in a future release. Instead use the CacheLib backend directly.
    warnings.warn(

tests/test_admin_kick_protection.py: 2 warnings
tests/test_admin_protection.py: 4 warnings
tests/test_authorization.py: 3 warnings
tests/test_basic.py: 3 warnings
tests/test_kick_member.py: 4 warnings
tests/test_maintenance.py: 2 warnings
tests/test_polls.py: 3 warnings
tests/test_user_deletion.py: 3 warnings
  C:\Python314\Lib\site-packages\flask_session\base.py:172: DeprecationWarning: The 'use_signer' option is deprecated and will be removed in the next minor release. Please update your configuration accordingly or open an issue.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_admin_protection.py::test_only_admin_can_delete_pin - asser...
================= 1 failed, 23 passed, 49 warnings in 22.80s ==================
